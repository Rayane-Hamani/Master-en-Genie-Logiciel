#include <errno.h>
#include <stdio.h>
#include <stdlib.h>

#include "dmps.h"
#include "drive.h"
#include "../../libhw/include/hardware.h"



void seek(unsigned int cylinder, unsigned int sector)
{
    /* Register the cylinder number */

    _out(HDA_DATAREGS+0, MSBIT(cylinder));
    _out(HDA_DATAREGS+1, LSBIT(cylinder));

    /* Register the sector number */

    _out(HDA_DATAREGS+2, MSBIT(sector));
    _out(HDA_DATAREGS+3, LSBIT(sector));

    /* Execute the seek command */

    _out(HDA_CMDREG, CMD_SEEK);

    /* Wait the interrupt signal */

    _sleep(HDA_IRQ);
}



void print(unsigned int cylinder, unsigned int sector)
{
    unsigned int i;

    /* Place the reader head */

    seek(cylinder, sector);

    /* Register 1 sector to read */

    _out(HDA_DATAREGS+0, MSBIT(1));
    _out(HDA_DATAREGS+1, LSBIT(1));

    /* Execute the read command */

    _out(HDA_CMDREG, CMD_READ);

    /* Wait the interrupt signal */

    _sleep(HDA_IRQ);

    /* Print the content of the sector */

    for(i=0; i<HDA_SECTORSIZE; i++)
    {
        if(i!=0)
        {
            switch(i%16)
            {
            case 0:
                printf("\n");
                break;
            case 8:
                printf("  ");
                break;
            default:
                printf(" ");
                break;
            }
        }
        
        printf("%02x", MASTERBUFFER[i]);
    }

    printf("\n");
}



void print_using_drive(unsigned int cylinder, unsigned int sector)
{
    unsigned int i;

    unsigned char buffer[HDA_SECTORSIZE];

    /* Read the sector */

    read_sector(cylinder, sector, buffer);

    /* Print the content of the sector */

    for(i=0; i<HDA_SECTORSIZE; i++)
    {
        if(i!=0)
        {
            switch(i%16)
            {
            case 0:
                printf("\n");
                break;
            case 8:
                printf("  ");
                break;
            default:
                printf(" ");
                break;
            }
        }
        
        printf("%02x", buffer[i]);
    }

    printf("\n");
}



void empty_it()
{
    return;
}



int main(int argc, char** argv)
{
    unsigned int i;
    unsigned int cylinder, sector;

    /* Check if cylinder and sector are OK */
    
    if(argc < 3)
    {
	    fprintf(stderr, "The program should be launched like that : ./dmps [0 <= number < 16] [0 <= number < 16]\n");
	    return EXIT_FAILURE;
    }

    errno = 0;

    cylinder = strtol(argv[1], NULL, 10);
    sector   = strtol(argv[2], NULL, 10);

    if(errno!=0 || 0>cylinder || cylinder>=HDA_MAXCYLINDER || 0>sector || sector>=HDA_MAXSECTOR)
    {
	    fprintf(stderr, "The program should be launched like that : ./dmps [0 <= number < 16] [0 <= number < 16]\n");
	    return EXIT_FAILURE;
    }

    /* Create virtual disks */

    if(init_hardware("hwconfig.ini") == 0)
    {
	    fprintf(stderr, "Error in hardware initialization\n");
	    return EXIT_FAILURE;
    }

    /* Interreupt handlers */

    for(i=0; i<16; i++)
    {
        IRQVECTOR[i] = empty_it;
    }
    
    /* Allow all interruptions */

    _mask(1);
    
    /* Print the sector */

    print_using_drive(cylinder, sector);

    /* Exit successfully the program */

    return EXIT_SUCCESS;
}