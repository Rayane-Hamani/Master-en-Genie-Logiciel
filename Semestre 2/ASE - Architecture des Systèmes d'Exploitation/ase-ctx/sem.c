#include <stdlib.h>

#include "ctx.h"
#include "sem.h"



void sem_init(struct sem_s *sem, unsigned int val)
{
    sem->cpt = val;
    sem->ctx = NULL;
}



void sem_up(struct sem_s *sem)
{
    irq_disable();

    sem->cpt++;

    if(sem->cpt <= 0)
    {
        struct ctx_s *tmp = sem->ctx;

        tmp->etat = ACTIF;

        sem->ctx = tmp->sem_suivant;

        tmp->sem_suivant = NULL;
    }

    irq_enable();
}



void sem_down(struct sem_s *sem)
{
    irq_disable();

    sem->cpt--;

    if(sem->cpt < 0)
    {
        ctx_courant->etat = VEROUILLE;

        if(sem->ctx)
            sem->ctx->suivant = ctx_courant;
        else
            sem->ctx = ctx_courant;

        yield();
    }

    irq_enable();
}