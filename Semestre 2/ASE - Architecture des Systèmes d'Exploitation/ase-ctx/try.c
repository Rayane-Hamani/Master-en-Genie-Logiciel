#include <assert.h>

#include "try.h"



static int val;



int try(struct ctx_s *pctx, func_t *f, int arg)
{
    asm("mov %%rsp, %0" "\n\t" "mov %%rbp, %1"
        : "=r"(pctx->sp),
          "=r"(pctx->bp));
    
    pctx->magic = CTX_MAGIC;

    return f(arg);
}



int throw(struct ctx_s *pctx, int r)
{
  assert(pctx->magic == CTX_MAGIC);
  
  val = r;

  asm("mov %0, %%rsp" "\n\t" "mov %1, %%rbp"
      :
      : "r"(pctx->sp),
        "r"(pctx->bp));

  return val;
}