#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "drive.h"
#include "../../libhw/include/hardware.h"



void seek_sector(unsigned int cylinder, unsigned int sector)
{
    /* Register the cylinder number */

    _out(HDA_DATAREGS+0, MSBIT(cylinder));
    _out(HDA_DATAREGS+1, LSBIT(cylinder));

    /* Register the sector number */

    _out(HDA_DATAREGS+2, MSBIT(sector));
    _out(HDA_DATAREGS+3, LSBIT(sector));

    /* Execute the seek command */

    _out(HDA_CMDREG, CMD_SEEK);
    
    /* Wait the interrupt signal */
    
    _sleep(HDA_IRQ);
}



void read_sector(unsigned int cylinder, unsigned int sector, unsigned char* buffer)
{
    /* Place the reader head */

    seek_sector(cylinder, sector);

    /* Register 1 sector to read */

    _out(HDA_DATAREGS+0, MSBIT(1));
    _out(HDA_DATAREGS+1, LSBIT(1));

    /* Execute the read command */

    _out(HDA_CMDREG, CMD_READ);

    /* Wait the interrupt signal */

    _sleep(HDA_IRQ);

    /* Put the sector read in the buffer */

    memcpy(buffer, MASTERBUFFER, HDA_SECTORSIZE);
}



void write_sector(unsigned int cylinder, unsigned int sector, const unsigned char* buffer)
{
    /* Place the reader head */

    seek_sector(cylinder, sector);

    /* Register 1 sector to write */

    _out(HDA_DATAREGS+0, MSBIT(1));
    _out(HDA_DATAREGS+1, LSBIT(1));

    /* Put the sector to write in the masterbuffer */

    memcpy(MASTERBUFFER, buffer, HDA_SECTORSIZE);

    /* Execute the write command */

    _out(HDA_CMDREG, CMD_WRITE);

    /* Wait the interrupt signal */

    _sleep(HDA_IRQ);
}



void format_sector(unsigned int cylinder, unsigned int sector, unsigned int nsector, unsigned int value)
{
    /* Place the reader head */

    seek_sector(cylinder, sector);

    /* Register nsector sectors to format */

    _out(HDA_DATAREGS+0, MSBIT(nsector));
    _out(HDA_DATAREGS+1, LSBIT(nsector));

    /* Register value as the formatting value */

    _out(HDA_DATAREGS+2, (value >> 24) & 0xFF);
    _out(HDA_DATAREGS+3, (value >> 16) & 0xFF);
    _out(HDA_DATAREGS+4, (value >>  8) & 0xFF);
    _out(HDA_DATAREGS+5, (value >>  0) & 0xFF);
    
    /* Execute the format command */

    _out(HDA_CMDREG, CMD_FORMAT);

    /* Wait the interrupt signal */

    _sleep(HDA_IRQ);
}

