#include "ctx.h"
#include "gdt.h"
#include "idt.h"
#include "ioport.h"
#include "miniio.h"



                  /*          0     1     2     3     4     5     6     7     8      9     a     b      c      d     e     f   */
char key_map[] =  /* 0x0 */ {      '0' , '1' , '2' , '3' , '4' , '5' , '6' , '7'  , '8' , '9' , '0'  , '-'  , '=' , '0' , '\t' ,
                  /* 0x1 */  'q' , 'w' , 'e' , 'r' , 't' , 'y' , 'u' , 'i' , 'o'  , 'p' , '[' , ']'  , '\n' , '0' , 'a' , 's'  ,
                  /* 0x2 */  'd' , 'f' , 'g' , 'h' , 'j' , 'k' , 'l' , ';' , '\'' , '`' , '0' , '\\' , 'z'  , 'x' , 'c' , 'v'  ,
                  /* 0x3 */  'b' , 'n' , 'm' , ',' , '.' , '/' , '0' , '*' , '0'  , ' ' , '0' };

unsigned char keyboard_map(unsigned char key)
{
  if(--key > 0x3a)
    return '\0';

  return key_map[key];
}

void key_irq(int_regs_t *r)
{
  unsigned char key = _inb(0x60);

  unsigned char c = keyboard_map(key);

  putc(c);
}



void yield_irq()
{
  yield();
}

ctx_t* ping_ctx = NULL;
ctx_t* pong_ctx = NULL;

sem_t ping_sem;
sem_t pong_sem;

void ping()
{
  while(1)
  {
    puts("PING\n");

    sem_down(&ping_sem);
    sem_up(&pong_sem);

    for(unsigned int i=0; i<100000000; i++) { /* nothing */ }
  }
}

void pong()
{
  while(1)
  {
    puts("\tPONG\n");

    sem_down(&pong_sem);
    sem_up(&ping_sem);

    for(unsigned int i=0; i<100000000; i++) { /* nothing */ }
  }
}



/* multiboot entry-point with datastructure as arg. */
void main(unsigned int * mboot_info)
{
    /* clear the screen */
    clear_screen();
    puts("Early boot.\n"); 
    puts("\t-> Setting up the GDT... ");
    gdt_init_default();
    puts("OK\n");

    puts("\t-> Setting up the IDT... ");
    setup_idt();
    puts("OK\n");

    puts("\n\n");

    idt_setup_handler(0, yield_irq);
    idt_setup_handler(1, key_irq);

    /* --------- */
    init_contexts();
    
    ping_ctx = alloc_context(ping, 0);
    pong_ctx = alloc_context(pong, 0);

    sem_init(&ping_sem, 1);
    sem_init(&pong_sem, 1);

    switch_to(ping_ctx); // will call yield after

    __asm volatile("sti");

    /* minimal setup done ! */


    puts("Going idle\n");
    clear_screen();
    puts("Hello World !\n");
    for(;;) ; /* nothing more to do... really nothing ! */
}
