#include <stdio.h>
#include <stdlib.h>

#include "drive.h"
#include "frmt.h"
#include "../../libhw/include/hardware.h"



void seek(unsigned int cylinder, unsigned int sector)
{
    /* Register the cylinder number */

    _out(HDA_DATAREGS+0, MSBIT(cylinder));
    _out(HDA_DATAREGS+1, LSBIT(cylinder));

    /* Register the sector number */

    _out(HDA_DATAREGS+2, MSBIT(sector));
    _out(HDA_DATAREGS+3, LSBIT(sector));

    /* Execute the seek command */

    _out(HDA_CMDREG, CMD_SEEK);
    
    /* Wait the interrupt signal */
    
    _sleep(HDA_IRQ);
}



void format()
{
    unsigned int cylinder, sector;
    
    for(cylinder=0; cylinder<HDA_MAXCYLINDER; cylinder++)
    {
        for(sector=0; sector<HDA_MAXSECTOR; sector++)
        {
            /* Place the reader head */

            seek(cylinder, sector);

            /* Register 1 sector to format */

            _out(HDA_DATAREGS+0, MSBIT(1));
            _out(HDA_DATAREGS+1, LSBIT(1));

            /* Register 0 as the formatting value */

            _out(HDA_DATAREGS+2, 0);
            _out(HDA_DATAREGS+3, 0);
            _out(HDA_DATAREGS+4, 0);
            _out(HDA_DATAREGS+5, 0);

            /* Execute the format command */

            _out(HDA_CMDREG, CMD_FORMAT);

            /* Wait the interrupt signal */

            _sleep(HDA_IRQ);
        }
    }
}



void format_using_drive()
{
    unsigned int cylinder, sector;
    
    for(cylinder=0; cylinder<HDA_MAXCYLINDER; cylinder++)
    {
        for(sector=0; sector<HDA_MAXSECTOR; sector++)
        {
            format_sector(cylinder, sector, 1, 0);
        }
    }
}



void empty_it()
{
    return;
}



int main()
{
    unsigned int i;

    /* Create virtual disks */

    if(init_hardware("hwconfig.ini") == 0)
    {
	    fprintf(stderr, "Error in hardware initialization\n");
	    return EXIT_FAILURE;
    }

    /* Interreupt handlers */

    for(i=0; i<16; i++)
    {
        IRQVECTOR[i] = empty_it;
    }
    
    /* Allow all interruptions */

    _mask(1);

    /* Format the disk */

    format_using_drive();

    /* Exit successfully the program */

    return EXIT_SUCCESS;
}