#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "drive.h"
#include "mbr.h"



struct mbr mbr;



void init_mbr()
{
    mbr.nvol = 0;
    mbr.magic = MAGIC;
    memset(&mbr.volumes, 0, sizeof(struct volume)*MAX_VOL);
}

void read_mbr()
{
    unsigned char buffer[HDA_SECTORSIZE];

    read_sector(0, 0, buffer);

    memcpy(&mbr, buffer, sizeof(struct mbr));

    if(mbr.magic != MAGIC)
    {
        init_mbr();
    }
}

void write_mbr()
{
    unsigned char buffer[HDA_SECTORSIZE];

    if(mbr.magic != MAGIC)
    {
	    fprintf(stderr, "Incorrect magic\n");
	    exit(EXIT_FAILURE);
    }

    memcpy(buffer, &mbr, sizeof(struct mbr));

    write_sector(0, 0, buffer);
}



unsigned int get_cylinder(unsigned int nvol, unsigned int nbloc)
{
    return (mbr.volumes[nvol].start + nbloc) / HDA_MAXCYLINDER;
}

unsigned int get_sector(unsigned int nvol, unsigned int nbloc)
{
    return (mbr.volumes[nvol].start + nbloc) % HDA_MAXSECTOR;
}



void read_bloc(unsigned int vol, unsigned int nbloc, unsigned char* buffer)
{
    unsigned int cylinder = get_cylinder(vol, nbloc);
    unsigned int sector   = get_sector(vol, nbloc);

    read_sector(cylinder, sector, buffer);
}

void write_bloc(unsigned int vol, unsigned int nbloc, unsigned char* buffer)
{
    unsigned int cylinder = get_cylinder(vol, nbloc);
    unsigned int sector   = get_sector(vol, nbloc);

    write_sector(cylinder, sector, buffer);
}

void format_vol(unsigned int vol)
{
    unsigned int cylinder = get_cylinder(vol, 0);
    unsigned int sector   = get_sector(vol, 0);
    unsigned int nsector  = mbr.volumes[vol].size;
    unsigned int value    = 0;

    format_sector(cylinder, sector, nsector, value);
}