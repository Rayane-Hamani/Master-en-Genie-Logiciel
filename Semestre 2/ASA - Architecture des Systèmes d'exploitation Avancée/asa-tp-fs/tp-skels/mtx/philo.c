/* 
   Les 5 philosophes Ã  la recherche de l'interblocage   
*/

#include <stdio.h>

#include "ctx.h"
#include "mtx.h"

static struct mtx_s forks[5];

void 
philo(void *arg)
{
    int me = (int) arg;
    do {
        /* think(); */
        if (mtx_lock(&forks[me]))
            printf("interblocage, philosophe %d, fourchette %d\n", me, me);
        yield();
        if(mtx_lock(&forks[(me+1)%5]))
            printf("interblocage, philosophe %d, fourchette %d\n", me, (me+1)%5);
        /* eat(); */
        mtx_unlock(&forks[me]);
        mtx_unlock(&forks[(me+1)%5]);
    } while(1);
}

void
other(void *arg)
{
    for(;;)
        ;
}

int
main ()
{
    int i;
    
    for (i=0 ; i<5 ; i++)
        mtx_init(forks+i);
    
    for (i=0 ; i<5 ; i++) 
        create_ctx(16384, philo, (void *) i);

    create_ctx(16384, other, (void *) 0);

    start_sched();
}

