#include <assert.h>
#include <stdio.h>

#include "mmu.h"
#include "include/hardware.h"



void mmuhandler()
{
    printf("tentative d’accès illégal à l’adresse %p\n", 
           ((long int)_in(MMU_FAULT_ADDR_HI)) << 32 | (_in(MMU_FAULT_ADDR_LO) & 0xFFFFFFFF));

           /* y'a clairement un truc à faire ici */
           /* initialiser la tlb ? */
}



int main() 
{
    union tlb_entry_u tlbu;
    tlbu.e.phys_page = 43;
    tlbu.e.is_active =  1;

    char *ptr;

    assert(init_hardware("etc/hardware.ini") != 0);

    for(int i=0; i<16; i++)
        IRQVECTOR[i] = NULL;

    IRQVECTOR[MMU_IRQ] = mmuhandler;

    /* associer à la dernière page virtuelle la page physique 2 */
    /* associer à la première page virtuelle la page physique 1 */

    _mask(0x1001); // mode user + accepte toutes les interruptions

    // ptr = (char*)0; // l'adresse 0 est (normalement) réservée

    /* on essaye d'écrire à la première puis dernière adresse de la mémoire virtuelle */
    // ptr = virtual_memory;
    // *ptr = 'c';
    
    ptr = LAST_VM_ADDRESS;
    *ptr = 'c';
}